#cloud-config

apt_update: true
apt_upgrade: true
packages:
 - python3-pip
 - python3-dev
 - build-essential
byobu_default: system

write_files:
  - path: /home/ubuntu/tasks.py
    content: |     
      from celery import Celery
      import json
      import os
      app = Celery('tasks', backend='rpc://', broker='pyamqp://guest@localhost//')
      @app.task
      def pronoun_count(folder):
          pronoun_list = ['han', 'hon', 'den', 'det', 'denna', 'denne', 'hen']
          pronoun_count = dict.fromkeys(pronoun_list, 0)
          list_of_files = os.listdir(folder)
          for one_file in list_of_files:
              f = open(folder + one_file)
              lines = f.readlines()
              for line in lines:
                  if line.strip():
                      dic = json.loads(line)
                      if "retweeted_status" not in dic:
                          list_of_words = dic['text'].split(" ")
                          for word in list_of_words:
                              word = word.strip(' .,:;!?')
                              word = word.lower()
                              if word in pronoun_list:
                                  pronoun_count[word] += 1
          return pronoun_count
  - path: /home/ubuntu/run_task.py
    content: |
      from tasks import pronoun_count
      from draw_chart import draw_bar_chart
      result = pronoun_count.delay('./tweet_pronoun_files/data/')
      #print("Status: ", result.status, "...")
      while(not (result.status == 'SUCCESS')):
          pass
      #print("Status: ", result.status)
      pronouns = []
      values = []
      result_dict = result.get()
      for x in result_dict:
          pronouns.append(x)
          values.append(result_dict[x])
      draw_bar_chart(pronouns, values)
  - path: /home/ubuntu/draw_chart.py
    content: |
      from termgraph import termgraph as tg
      def draw_bar_chart(labels, values):
          data = []
          normal_data = []
          total_pronouns = 0
          for x in values:
              total_pronouns += x
          for value in values:
              data.append([value])
              normalized_value = value/4000
              normal_data.append([normalized_value])
          len_categories = 1
          args = {'filename': 'data/ex4.dat', 'title': None, 'width': 10,
              'format': '{:<5.2f}', 'suffix': '', 'no_labels': False,
              'color': None, 'vertical': False, 'stacked': True,
              'different_scale': False, 'calendar': False,
              'start_dt': None, 'custom_tick': '', 'delim': '',
              'verbose': False, 'version': False}
          colors = [91]
          tg.stacked_graph(labels, data, normal_data, len_categories, args, colors)
  - path: /home/ubuntu/pronoun_counter.py
    content: |
      from flask import Flask, jsonify
      import subprocess
      import sys
      app = Flask(__name__)
      @app.route('/pronoun_counter', methods=['GET'])
      def count_pronouns():
          print("Counting pronouns...")
          data = subprocess.check_output(["python3","run_task.py"])
          return data
      if __name__== '__main__':
          app.run(host='0.0.0.0', debug=True)

runcmd:
 - sudo bash
 - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
 - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
 - apt-get update
 - apt-get install -y docker-ce
 - apt-get -y upgrade
 - apt-get install -y git
 - cd /home/ubuntu
 - sudo git clone https://github.com/lovvvan/tweet_pronoun_files.git
 - apt-get install -y python3-pip
 - pip install --upgrade pip
 - pip install flask
 - pip install celery
 - apt-get install -y rabbitmq-server
 - systemctl enable rabbitmq-server
 - systemctl start rabbitmq-server
 - pip install termgraph
 - python3 pronoun_counter.py &
 - celery -A tasks worker --loglevel=INFO
 